#!/bin/bash
#
# Univention Client Login
#  helper script
#
# Copyright (C) 2001, 2002, 2003, 2004, 2005, 2006 Univention GmbH
#
# http://www.univention.de/
#
# All rights reserved.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License version 2 as
# published by the Free Software Foundation.
#
# Binary versions of this file provided by Univention to you as
# well as other copyrighted, protected or trademarked materials like
# Logos, graphics, fonts, specific documentations and configurations,
# cryptographic keys etc. are subject to a license agreement between
# you and Univention.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA

# ONLY SOURCE THIS FILE (otherwhise $$ and $PPID are wrong)

# kill all remaining processes, which have the display set to the dead machine
for i in `find /proc -mindepth 1 -maxdepth 1 -user $USER`; do
	PID=${i/*\//};
	if [ -r $i/cmdline ]; then
	    CMD=`cat $i/cmdline`;
	else
	    CMD="";
	fi;
	if [ -r $i/environ ]; then
		PDISPLAY=`(cat $i/environ) | tr "\000" "\n" | \
		    grep "^DISPLAY="`
		PDISPLAY=${PDISPLAY/*DISPLAY=/}
		echo might kill $PID $PDISPLAY "("$CMD")" 1>&2;
		# we must not kill our self nor our parent
		if [ "$PDISPLAY" != "$DISPLAY" ]; then continue; fi;
		if [ $PID -eq $$ ]; then continue; fi;
		if [ $PID -eq $PPID ]; then continue; fi;
		echo killing $PID $PDISPLAY "("$CMD")" 1>&2;
		kill -TERM $PID;
		sleep 1;
		if [ -e $i/environ ]; then
			echo "trying harder" 1>&2;
			kill -KILL $PID;
		fi;
	fi;
done;
