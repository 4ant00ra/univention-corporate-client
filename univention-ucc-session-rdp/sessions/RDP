#!/bin/bash
#
# UCC - RDP session script
#
# Copyright (C) 2012 Univention GmbH
#
# http://www.univention.de/
#
# All rights reserved.
#
# The source code of this program is made available
# under the terms of the GNU Affero General Public License version 3
# (GNU AGPL V3) as published by the Free Software Foundation.
#
# Binary versions of this program provided by Univention to you as
# well as other copyrighted, protected or trademarked materials like
# Logos, graphics, fonts, specific documentations and configurations,
# cryptographic keys etc. are subject to a license agreement between
# you and Univention and not subject to the GNU AGPL V3.
#
# In the case you use this program under the terms of the GNU AGPL V3,
# the program is provided in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public
# License with the Debian GNU/Linux or Univention distribution in file
# /usr/share/common-licenses/AGPL-3; if not, see
# <http://www.gnu.org/licenses/>.

# force user session
if [ -e /usr/share/univention-lightdm/force-user-session ]; then
    . /usr/share/univention-lightdm/force-user-session
fi

. /usr/share/univention-lib/all.sh

function cleanup_and_exit {
    if test -e /tmp/passwd; then
	rm -rf /tmp/passwd
    fi
    exit
}

eval "$(/usr/sbin/univention-config-registry shell)"

params=""

if is_ucr_true 'rdp/checknla'; then
    echo "By default NLA validation is enabled"
else
    echo "Disabling NLA validation"
    params="$params --no-nla"
fi

if is_ucr_true 'rdp/checktls'; then
    echo "By default TLS validation is enabled"
else
    echo "Disabling TLS validation"
    params="$params --no-tls"
fi


if test -e /tmp/passwd; then
    PASSWD=`cat /tmp/passwd`
    params="$params -p $PASSWD"
fi

if [ -n "$rdp_keyboard" ]; then
    params="$params -k $rdp_keyboard"
else
    rdpKeyboard=`univention-keyboardmapping --xtofreerdp $xorg_keyboard_options_XkbLayout`
    params="$params -k $rdpKeyboard"
fi

if is_ucr_true 'rdp/disable-sound'; then
	echo "Deactivating sound output"
else
 	params="$params --plugin rdpsnd"
fi

if is_ucr_true 'rdp/redirectdisk'; then
    params="$params --plugin rdpdr --data disk:local-drives:/var/drives"
fi

if [ -n "$rdp_user" ]; then
    params="$params -u $rdp_user"
else
    params="$params -u $USER"
fi

if [ -n "$rdp_domainname" ]; then
    params="$params -d $rdp_domainname"
else
    policy_windows_domain=`grep -A 1 univentionCorporateClientUserWindowsDomain /tmp/"$USER"-policy.txt  | grep Value | awk -F ":" '{print $2}' | sed -e 's/^[[:space:]]*//' `
    params="$params -d $policy_windows_domain"
fi

policy_windows_ts=`grep -A 1 univentionCorporateClientUserWindowsTerminalserver /tmp/"$USER"-policy.txt  | grep Value | awk -F ":" '{print $2}' | sed -e 's/^[[:space:]]*//' `

server=""
if [ -n "$policy_windows_ts" ]; then
	server="$policy_windows_ts"
fi

if [ -n "$rdp_server" ]; then
	server="$rdp_server"
fi

if [ -z "$server" ]; then
	messageFile=$(mktemp)
	echo "
No RDP server was found.

The RDP server can configured via the input field Windows
terminal server in the UCC user session policy or by
or by setting the UCR variable rdp/server via an UCR policy.
" >>$messageFile
	xmessage -file "$messageFile"
	cleanup_and_exit
fi

/usr/bin/xfreerdp $params $server
ret=$?

if [ $ret == 131 ]; then
    xmessage "Could not contact terminal server" "$server"
fi

#cleanup_and_exit

